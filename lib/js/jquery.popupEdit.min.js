
(function(a){a.widget("dsabs.popupEdit",{options:{popup:null,submitText:"Submit",ajaxParameter:"ajax",dialog:{modal:true,autoOpen:true,width:450},templates:{errorPopup:a('<div id="errorPopup" class="errorPopup"></div>')}},_create:function(){if(this.options.popup===null){console.error("Missing option: popup");return false}this._config={targetUrl:this._getTarget(),dataUrl:this._checkUrl(this.element.data("dataUrl")),dialog:{open:this.options.dialog.open,close:this.options.dialog.close}};this._addListener()},_getTarget:function(){var b=document.createElement("a");if(this.element.attr("href")){b.href=this.element.attr("href")}if(this.element.attr("src")){b.href=this.element.attr("src")}if(b.href===""){console.error("No target found!")}return this._checkUrl(b)},_checkUrl:function(c){var b;if(typeof c==="undefined"){return}if(typeof c==="string"){b=document.createElement("a");b.href=c}else{b=c}if(b.search.search(this.options.ajaxParameter)===-1){if(b.search===""){b.search="?"+this.options.ajaxParameter+"=1"}else{b.search+="&"+this.options.ajaxParameter+"=1"}}return b.href},_addListener:function(){this.element.on("click.pe touch.pe",a.proxy(function(b){b.preventDefault();this._createPopup()},this))},_createPopup:function(){if(typeof a(this.options.popup).dialog("instance")!=="undefined"){return}a(this.options.popup).dialog(a.extend(true,this.options.dialog,{open:a.proxy(this._openCallback,this),close:a.proxy(this._closeCallback,this)}))},_openCallback:function(c){var b=a(c.target);if(this._config.dataUrl){a.ajax(this._config.dataUrl,{success:a.proxy(function(d){this._successCallback(b,d.data)},this),error:a.proxy(function(d){if(typeof d.error!=="undefined"){this._error(d.error)}else{this._error(this.window[0].translations.unkownError)}},this)})}b.find(".buttonArea").children(":submit").val(this.options.submitText);b.children("form").on("submit",a.proxy(function(f){f.preventDefault();var g={},e=a(f.target),j=e.serializeArray(),h,d;for(d=0;d<j.length;d++){h=j[d];g[h.name]=h.value}a.post(this._config.targetUrl,{data:g},function(i){document.location.reload()},"json")},this));if(typeof this._config.dialog.open==="function"){this._config.dialog.open(c)}},_closeCallback:function(c){var b=a(c.target);b.find("input:not([type=submit])").val("");b.find("input[type=checkbox], input[type=radio]").prop("checked",false);b.children("form").off("submit");b.dialog("destroy");if(typeof this._config.dialog.close==="function"){this._config.dialog.close(c)}},_successCallback:function(c,b){a(c).children("form").find(":input").each(function(d,e){if(b[a(e).attr("name")]){if(a(e).is("input[type=checkbox], input[type=radio]")){a(e).val(1).prop("checked",b[a(e).attr("name")])}else{a(e).val(b[a(e).attr("name")])}}})},_error:function(c){var b;if(a("#"+this.options.templates.errorPopup.attr("id")).length>0){a("#"+this.options.templates.errorPopup.attr("id")).remove()}b=this.options.templates.errorPopup.clone();b.text(c);a("body").append(b);b.dialog({title:this.window[0].translations.error,modal:true})},_destroy:function(){this.element.off("click.pe touch.pe")}})}(jQuery));