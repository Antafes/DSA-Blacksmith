$.widget("dsabs.materialSelect",{options:{appendForceModificatorSelectTo:"",data:{},addLink:null,selectName:"material",percentageName:"percentage",forceModificatorName:"materialForceModificator",target:"tbody",templates:{tableRow:$('<tr><td class="material"></td><td class="percentage"></td><td></td></tr>'),select:$("<select></select>"),percentageInput:$('<input class="percentage" type="number" min="1" max="100" /><span>&nbsp;%<span>'),removeLink:$('<a class="removeRow" href="#">X</a>'),materialForceModificatorInput:$('<input class="materialForceModificator" type="hidden" />'),forceModificatorSelectPopup:$('<div style="display: none;"><form method="post" action="index.php"><select></select><br /><input type="submit" value="Ok" /></form></div>')}},_create:function(){var a=this;this._config={rowCount:0};this._addOptions();this._buildRow();this._addRow();$(this.options.addLink).on("click.ms",function(){a._addRow()});this.element.show()},_addOptions:function(){var a=this;$.each(this.options.data,function(c,e){var d=$("<option></option>"),b={};d.attr("value",e.id);d.text(e.name);$.each(e.materialAssets,function(f,g){b[g.percentage]=g.forceModificator});d.data("forceModificator",b);a.options.templates.select.append(d)})},_buildRow:function(){var a=this;this.options.templates.tableRow.children(".material").append(this.options.templates.select);this.options.templates.tableRow.children(".percentage").append(this.options.templates.materialForceModificatorInput);this.options.templates.percentageInput.on("change",function(){var f=$(this),e=f.parent().parent().children(".material").children("select").children("option:selected").data("forceModificator");for(var d in e){var b=e[d];if(f.val()>=d){if(b.length>1){var c=a.options.templates.forceModificatorSelectPopup.clone();$.each(b,function(g,h){var i=$("<option></option>");i.attr("value",h.attack+"/"+h.parade);i.text(h.attack+"/"+h.parade);c.children("form").children("select").append(i);c.dialog({modal:true,autoOpen:true,closeOnEscape:false,dialogClass:"no-close",appendTo:"",open:function(){var j=$(this);j.children("form").submit(function(k){k.preventDefault();f.parent().children("input[type=hidden]").val($(this).val());j.dialog("close")})},close:function(){$(this).dialog("destroy")}})})}else{f.parent().children("input[type=hidden]").val(b[0].attack+"/"+b[0].parade)}}}});this.options.templates.tableRow.children(".percentage").append(this.options.templates.percentageInput);this.options.templates.removeLink.on("click.ms",function(){$(this).parent().parent().remove()});this.options.templates.tableRow.children("td:last").append(this.options.templates.removeLink)},_addRow:function(){var a=this.options.templates.tableRow.clone(true);a.children(".material").children("select").attr("name",this.options.selectName+"["+this._config.rowCount+"]");a.children(".percentage").children(".percentage").attr("name",this.options.percentageName+"["+this._config.rowCount+"]");a.children(".percentage").children(".materialForceModificator").attr("name",this.options.forceModificatorName+"["+this._config.rowCount+"]");this.element.children(this.options.target).append(a);this._config.rowCount++;this.element.show()}});