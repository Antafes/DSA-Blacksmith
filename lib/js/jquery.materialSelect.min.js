$.widget("dsabs.materialSelect",{options:{appendWeaponModificatorSelectTo:"",materials:{},talents:{},addLink:null,selectName:"material",percentageName:"percentage",talentSelectName:"talent",weaponModificatorName:"materialWeaponModificator",target:"tbody",templates:{tableRow:$('<tr><td class="material"></td><td class="percentage"></td><td class="talent"></td><td></td></tr>'),select:$("<select></select>"),percentageInput:$('<input class="percentage" type="number" min="1" max="100" /><span>&nbsp;%<span>'),talentSelect:$("<select></select>"),removeLink:$('<a class="removeRow" href="#">X</a>'),materialWeaponModificatorInput:$('<input class="materialWeaponModificator" type="hidden" />'),weaponModificatorSelectPopup:$('<div style="display: none;"><form method="post" action="index.php"><label for="materialWeaponModificator"></label> <select id="materialWeaponModificator"></select><br /><input type="submit" value="Ok" /></form></div>')}},_create:function(){this._config={rowCount:0};this._addOptions();this._buildRow();this._addRow();$(this.options.addLink).on("click.ms",$.proxy(function(){this._addRow()},this));this.element.show()},_addOptions:function(){$.each(this.options.materials,$.proxy(function(a,c){var b=$("<option></option>"),d={};b.attr("value",c.id);b.text(c.name);$.each(c.materialAssets,function(e,f){d[f.percentage]=f.weaponModificator});b.data("weaponModificator",d);this.options.templates.select.append(b)},this));$.each(this.options.talents,$.proxy(function(a,c){var b=$("<option></option>");b.attr("value",a);b.text(c);this.options.templates.talentSelect.append(b)},this))},_buildRow:function(){var a=this;this.options.templates.tableRow.children(".material").append(this.options.templates.select);this.options.templates.tableRow.children(".percentage").append(this.options.templates.materialWeaponModificatorInput);this.options.templates.tableRow.children(".talent").append(this.options.templates.talentSelect);this.options.templates.percentageInput.on("change",function(){var e=$(this),f=e.parent().parent().children(".material").children("select").children("option:selected").data("weaponModificator");for(var d in f){var b=f[d];if(e.val()>=d){if(b.length>1){var c=a.options.templates.weaponModificatorSelectPopup.clone();$.each(b,function(g,h){var i=$("<option></option>");i.attr("value",h.attack+"/"+h.parade);i.text(h.attack+"/"+h.parade);c.children("form").children("select").append(i);c.children("form").children("label").text(window.translations.atPa);c.dialog({title:window.translations.chooseWeaponModificator,modal:true,autoOpen:true,closeOnEscape:false,dialogClass:"no-close",appendTo:"",open:function(){var j=$(this);j.children("form").submit(function(k){k.preventDefault();e.parent().children("input[type=hidden]").val($(this).children("select").val());j.dialog("close")})},close:function(){$(this).dialog("destroy")}})})}else{if(b.length>0){e.parent().children("input[type=hidden]").val(b[0].attack+"/"+b[0].parade)}}}}});this.options.templates.tableRow.children(".percentage").append(this.options.templates.percentageInput);this.options.templates.removeLink.on("click.ms",function(){$(this).parent().parent().remove()});this.options.templates.tableRow.children("td:last").append(this.options.templates.removeLink)},_addRow:function(){var a=this.options.templates.tableRow.clone(true);a.children(".material").children("select").attr("name",this.options.selectName+"["+this._config.rowCount+"]");a.children(".percentage").children(".percentage").attr("name",this.options.percentageName+"["+this._config.rowCount+"]");a.children(".percentage").children(".materialWeaponModificator").attr("name",this.options.weaponModificatorName+"["+this._config.rowCount+"]");a.children(".talent").children("select").attr("name",this.options.talentSelectName+"["+this._config.rowCount+"]");this.element.children(this.options.target).append(a);this._config.rowCount++;this.element.show()},_destroy:function(){$(this.options.addLink).off("click.ms");this.clear();this.options.templates.talentSelect.children().remove();this.options.templates.select.children().remove()},addRow:function(a){var b;this._addRow();b=this.element.children(this.options.target).children("tr:last");b.children(".material").children().val(a.material);b.children(".percentage").children().val(a.percentage);b.children(".talent").children().val(a.talent)},clear:function(){this.element.children(this.options.target).find("[class="+this.options.templates.removeLink.attr("class")+"]").trigger("click.ms");this._config.rowCount=0}});